<!doctype html>
<html lang="nl">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <main>
    <h1>Actuele CO2 waarden op het Emmauscollege</h1>

    <label for="datum">Datum:</label>
    <input type="date" id="datum" name="datum">
    <label for="hour">Uur:</label>
    <input type="number" id="hourField" name="hour" min="00" max="23">
    <button onclick="onFetchDataClick()">fetch</button>

    <!-- plattegrond -->
    <article class="plattegrond">
      hier komt een plattegrond, open console in browser om ingelezen waarden te zien
    </article>
  </main>

  <!-- voettekst -->
  <footer>
    <hr>
    <p>Het maken van deze website is een opdracht voor het vak informatica op het Emmauscollege Rotterdam.</p>
  </footer>

  <!-- api scripts -->
  <script>
    // https://www.air-insight.com/rooms/7fa1088d-3402-470c-88bf-9b351c5fd029 QR-code B27
    // https://www.air-insight.com/rooms/be582ae3-e935-4401-8b16-4286121de8bb QR-code B42
    var dag;
    var dagvuil;
    var uur = "00";

    const alles = [
      { lokaal: "B27", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%408a9dd17c-d814-4739-861a-074787b527ed&range=%22", CO2: null },
      { lokaal: "B42", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%406be403ac-bc6f-4d31-a4f4-4b97ed023f09&range=%22", CO2: null }
    ];




    function fetchData(dag) {
      for (let i = 0; i < alles.length; i++) {
        if (dag) {
          var request = new XMLHttpRequest()
          request.open('GET', alles[i].link + dag + '%22', true) // Link verschilt per sensor en kan worden gevonden in de ontwikkelmodus van de browser bij het laden van de pagina op de QR-code
          request.setRequestHeader('Content-Type', 'application/json')
          request.setRequestHeader('Authorization', 'lkDvA5MDW8vA#N5XVV8vkvA5AqJX*1') // Authorization is in de praktijk hetzelfde voor alle sensoren
          request.setRequestHeader('x-iot-unica-tenantid', '4c4411d0-1947-4fc5-8bd3-08d945fda0ae') // tenantid is in de praktijk hetzelfde voor alle sensoren binnen onze school
          request.onload = function () {
            // de functie showProducts wordt aangeroepen als er antwoord van de API is
            showProducts(this.response, alles[i])
          }
          request.send()
        }
      }
    };

    function onFetchDataClick() {
      event.preventDefault()
      const datumVeldWaarde = document.getElementById("datum").value
      uur = document.getElementById("hourField").value
      uur = (uur < 10 ? '0' : '') + uur
      fetchData(datumVeldWaarde)
    }

    // deze functie zet de producten op het scherm
    // nadat de API is aangeroepen
    function showProducts(lokaalCensorData, lokaalData) {
      let data = JSON.parse(lokaalCensorData) // vertaal response van API naar array met producten
      let CO2vuil = data.rows.find(r => r.ts.includes(`T${uur}`)).val // vuile formaat is String n:xxxx
      const CO2 = parseInt(CO2vuil.replace("n:", ""));  // haalt de n weg
      lokaalData.CO2 = CO2;
      console.log("Lokaal: " + lokaalData.lokaal, "CO2 waarde:" + lokaalData.CO2);
      /*
            for (let row in data) { // herhaal voor elke product
              const product = data[row]
              var name = product.name.substr(0, 35)
              if(name.length < product.name.length) {
                name = name + '...'
              }
              // voeg product toe aan DOM, 
              // zodat deze zichtbaar wordt op de webpagina
              const clone = template.content.cloneNode(true);
              clone.querySelector(".product_title").textContent = name
              clone.querySelector(".product_description").textContent =`${product.description.substr(0, 100)}...`
              clone.querySelector(".product_price").textContent = `â‚¬ ${product.price.toFixed(2)}`
              clone.querySelector(".product_code").textContent = product.code
              clone.querySelector(".product_id").value = product.id
              clone.querySelector(".product_id").dataset.json = JSON.stringify(product)
              clone.querySelector(".product_image").src =`/images/${product.id}.jpg
              container.appendChild(clone)
            }
      */
    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.js"> </script>
  <script>
    var beganegrondImg;
    var verdieping1Img;
    var verdieping2Img;

    function preload() {
      beganegrondImg = loadImage('afbeeldingen/beganegrond.png');
      verdieping1Img = loadImage('afbeeldingen/verdieping1.png');
      verdieping2Img = loadImage('afbeeldingen/verdieping2.png');
    }

    function setup() {
      createCanvas(1280, 720);
    };

    var kleurtekenen = function (CO2) {
      if (CO2) {
        if (CO2 > 1000) {
          fill('rgba(250,0,0,.5)'); //rood
        };

        if (CO2 < 1000) {
          fill('rgba(250,165,0,.5)');//oranje
        };

        if (CO2 < 800) {
          fill('rgba(0,250,0,.5)'); //groen
        };
      }
    };

    var tekenVerdiepingBG = function () {


    };

    var tekenVerdieping1 = function () {
      rect(0, 0, width, height);
      image(verdieping1Img, 0, 0, width);
      //console.log(mouseX);
      //console.log(mouseY);
      let lokaal = alles.find(al => al.lokaal === "B42");
      rect(902, 147, 82, 43); //b42
      kleurtekenen(lokaal.CO2);

      lokaal = alles.find(al => al.lokaal === "B27");
      rect(369, 238, 52, 91); //b27
      kleurtekenen(lokaal.CO2);
    };

    var tekenVerdieping2 = function () {

    };


    function draw() {
      tekenVerdieping1();

    };

  </script>


</body>

</html>