<!doctype html>
<html lang="nl">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <main>
    <h1>Actuele CO2 waarden op het Emmauscollege</h1>

    <label for="datum">Datum:</label>
    <input type="date" id="datum" name="datum">
    <label for="hour">Uur:</label>
    <input type="number" id="tijd" name="tijd" min="00" max="23">
    <!--  <input type="time" id="hourField" name="hour" min="00" max="23"> -->

    <button onclick="onFetchDataClick()">go</button>

    <!-- plattegrond -->
    <article class="plattegrond">
      hier komt een plattegrond, open console in browser om ingelezen waarden te zien
    </article>

    <div class="verdiepingen">
      <button onclick="openVerdieping(BG)">verdieping BG</button>
      <button onclick="openVerdieping(ver1)">verdieping 1</button>
      <button onclick="openVerdieping(ver2)">verdieping 2</button>
    </div>
  </main>

  <!-- api scripts -->
  <script>
    // https://www.air-insight.com/rooms/7fa1088d-3402-470c-88bf-9b351c5fd029 QR-code B27
    // https://www.air-insight.com/rooms/be582ae3-e935-4401-8b16-4286121de8bb QR-code B42
    var dag;
    var dagvuil;
    var uur = "00";

    var BG = 0;
    var ver1 = 1;
    var ver2 = 2;

    var plattegrond = ver1;

    const alles = [
      // { lokaal: "", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: , coordinaatY: , coordinaatL: , coordinaatB:  },  
      // { lokaal: "B27", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%408a9dd17c-d814-4739-861a-074787b527ed&range=%22", CO2: null, coordinaatX: coordinaatY: , coordinaatL: , coordinaatB:  },
      //  { lokaal: "B42", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%406be403ac-bc6f-4d31-a4f4-4b97ed023f09&range=%22", CO2: null, coordinaatX: coordinaatY: , coordinaatL: , coordinaatB:  },

      { lokaal: "C1", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40ea7b0abd-d369-4353-baba-529c3ea762bc&range=%22", CO2: null, coordinaatX: 361, coordinaatY: 426, coordinaatL: 57, coordinaatB: 44 },
      // { lokaal: "C2", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 418, coordinaatY: 426, coordinaatL: 57, coordinaatB: 44 },
      // { lokaal: "C5", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 475, coordinaatY:426 , coordinaatL: 57, coordinaatB: 44 },    
      { lokaal: "C6", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%409c7c718b-ea4e-4c89-a801-2d49d5e196b1&range=%22", CO2: null, coordinaatX: 532, coordinaatY: 426, coordinaatL: 57, coordinaatB: 44 },
      // { lokaal: "C08", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 589, coordinaatY: 395, coordinaatL: 56, coordinaatB: 75 },  
      // { lokaal: "C10", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 729, coordinaatY: 350, coordinaatL: 55, coordinaatB: 46 },
      // { lokaal: "C12", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 856, coordinaatY: 350, coordinaatL: 69, coordinaatB: 46 },    
      { lokaal: "C14", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40e2882615-ad03-46c3-86c3-646243d1eae2&range=%22", CO2: null, coordinaatX: 968, coordinaatY: 374, coordinaatL: 70, coordinaatB: 46 },
      // { lokaal: "BINAS-LAB", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 729, coordinaatY: 255, coordinaatL: 98, coordinaatB: 77 },  
      { lokaal: "C15", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40dc10ef78-8359-4bc2-9c09-7fa429744e66&range=%22", CO2: null, coordinaatX: 1039, coordinaatY: 363, coordinaatL: 57, coordinaatB: 57 },
      { lokaal: "C17", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40d87fd0c9-6b76-4673-93a7-36f64ff5a846&range=%22", CO2: null, coordinaatX: 1039, coordinaatY: 281, coordinaatL: 57, coordinaatB: 55 },
      { lokaal: "C18", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40a16caa09-bc42-416c-8ad9-c6bf393ec6ac&range=%22", CO2: null, coordinaatX: 939, coordinaatY: 281, coordinaatL: 70, coordinaatB: 44 },
      // { lokaal: "C23", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 645, coordinaatY: 332, coordinaatL: 64, coordinaatB: 44 },  
      // { lokaal: "C24", link: "https://api.co2.creamcookies.net/hs/", CO2: null, coordinaatX: 590, coordinaatY: 332, coordinaatL: 55, coordinaatB: 44 },  
      { lokaal: "C25", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40fcf70045-35a1-4ba5-b800-c93b66978645&range=%22", CO2: null, coordinaatX: 533, coordinaatY: 332, coordinaatL: 57, coordinaatB: 44 },
      { lokaal: "C26", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%40904f1bb2-8b78-429c-aa64-deebeb3c148e&range=%22", CO2: null, coordinaatX: 476, coordinaatY: 332, coordinaatL: 57, coordinaatB: 44 },
      { lokaal: "C27", link: "https://api.co2.creamcookies.net/hs/hisRead?id=%4062f7fcda-b2e0-46e2-80e5-25d835b8dc31&range=%22", CO2: null, coordinaatX: 419, coordinaatY: 332, coordinaatL: 57, coordinaatB: 44 },

    ];




    function fetchData(dag) {
      for (let i = 0; i < alles.length; i++) {
        if (dag) {
          var request = new XMLHttpRequest()
          request.open('GET', alles[i].link + dag + '%22', true) // Link verschilt per sensor en kan worden gevonden in de ontwikkelmodus van de browser bij het laden van de pagina op de QR-code
          request.setRequestHeader('Content-Type', 'application/json')
          request.setRequestHeader('Authorization', 'lkDvA5MDW8vA#N5XVV8vkvA5AqJX*1') // Authorization is in de praktijk hetzelfde voor alle sensoren
          request.setRequestHeader('x-iot-unica-tenantid', '4c4411d0-1947-4fc5-8bd3-08d945fda0ae') // tenantid is in de praktijk hetzelfde voor alle sensoren binnen onze school
          request.onload = function () {
            // de functie showProducts wordt aangeroepen als er antwoord van de API is
            showProducts(this.response, alles[i])
          }
          request.send()
        }
      }
    };

    function onFetchDataClick() {
      event.preventDefault()
      const datumVeldWaarde = document.getElementById("datum").value
      uur = document.getElementById("tijd").value
      uur = (uur < 10 ? '0' : '') + uur
      console.log(uur);
      fetchData(datumVeldWaarde)
    }

    // deze functie zet de producten op het scherm
    // nadat de API is aangeroepen
    function showProducts(lokaalCensorData, lokaalData) {
      let data = JSON.parse(lokaalCensorData) // vertaal response van API naar array met producten
      const alleCO2Waarde = data.rows.filter(r => r.ts.includes(`T${uur}`)).map(r => +r.val.replace("n:", "")); // haalt alle CO2 waarde uit van het gegeven uur
      const CO2Gemiddeld = alleCO2Waarde.reduce((a, b) => a + b, 0) / alleCO2Waarde.length; // haalt gemiddelde uit van de gegeven uur
      lokaalData.CO2 = CO2Gemiddeld;
      console.log("Lokaal: " + lokaalData.lokaal, "CO2 waarde:" + lokaalData.CO2);
      openVerdieping(plattegrond)
    }

  </script>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.js"> </script>
  <script>
    var beganegrondImg;
    var verdieping1Img;
    var verdieping2Img;

    function preload() {
      beganegrondImg = loadImage('afbeeldingen/beganegrond.png');
      verdieping1Img = loadImage('afbeeldingen/verdieping1.png');
      verdieping2Img = loadImage('afbeeldingen/verdieping2.png');
    }

    function setup() {
      createCanvas(1280, 720);
    };

    var kleurtekenen = function (CO2) {
      if (CO2) {
        if (CO2 > 1000) {
          fill('rgba(250,0,0,.5)'); //rood
        };

        if (CO2 < 1000) {
          fill('rgba(250,165,0,.5)');//oranje
        };

        if (CO2 < 700) {
          fill('rgba(0,250,0,.5)'); //groen
        };
      }
    };

    var tekenVerdiepingBG = function () {
      rect(0, 0, width, height);
      image(beganegrondImg, 0, 0, width);
      /*
      // lokaal = alles.find(al => al.lokaal === "");
      rect(, , , ); //
      //kleurtekenen(lokaal.CO2);
      */
    };

    var tekenVerdieping1 = function () {
      rect(0, 0, width, height);
      image(verdieping1Img, 0, 0, width);
      //console.log(mouseX);
      //console.log(mouseY);

    };

    var tekenVerdieping2 = function () {
      rect(0, 0, width, height);
      image(verdieping2Img, 0, 0, width);
      noFill();
      // console.log(mouseX);
      // console.log(mouseY);


      for (var i = 0; i < alles.length; i++) {
        lokaal = alles.find(al => al.lokaal === alles[i].lokaal);
        // lokaalF = lokaal.replace(/\d$/, '');
        // console.log(lokaalF);
        //if (lokaalF === "C") {
        kleurtekenen(lokaal.CO2);
        rect(alles[i].coordinaatX, alles[i].coordinaatY, alles[i].coordinaatL, alles[i].coordinaatB);
        // };
      };
    };

    function openVerdieping(plat) {
      switch (plat) {
        case ver2:
          plattegrond = ver2
          tekenVerdieping2();
          break;
        case ver1:
          plattegrond = ver1
          tekenVerdieping1();
          break;
        case BG:
          plattegrond = BG
          tekenVerdiepingBG();
          break;
        default:
          break;
      }
    }

    function draw() {
      openVerdieping(plattegrond)
    }

  </script>

  <!-- voettekst -->
  <footer>
    <hr>
    <p>Het maken van deze website is een opdracht voor het vak informatica op het Emmauscollege Rotterdam.</p>
  </footer>


</body>

</html>